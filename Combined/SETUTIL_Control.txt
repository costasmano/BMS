If (False)ÊÊ` ----------------------------------------------------ÊÊ` User name (OS): costasmanousakisÊÊ` User name (4D): DesignerÊÊ` Date and time: 04/14/10, 16:24:36ÊÊ` ----------------------------------------------------ÊÊ` Method: SETUTIL_ControlÊÊ` DescriptionÊÊ` Do SET commands using record IDs instead of 4D SetsÊÊ` ÊÊ` ParametersÊÊ` $1 : $TASK_txt :  "SAVE" ; "LOAD" ; "ADD"  "SUBTRACT"; "INTERSECT"ÊÊ` $2 : $KeyFld_ptrÊÊ` ----------------------------------------------------Mods_2010_04 ÊÊ` Modified by: Costas Manousakis-(Designer)-(12/23/13 08:41:54)Mods_2013_12 ÊÊ`ÊÊ`Added INTERSECT task ; a tag at the beginnig of the set file; a return boolean if all is ok;ÊÊ`ÊÊ`Adjusted method of saving set file - added 4st extensionEnd if C_BOOLEAN($0;$SET_OK_b)C_TEXT($1;$TASK_txt)$TASK_txt:=$1C_POINTER($2;$KeyFld_ptr)$KeyFld_ptr:=$2C_LONGINT($Table_L;$Field_L;$FieldType_L)$Field_L:=Field($KeyFld_ptr)$Table_L:=Table($KeyFld_ptr)C_POINTER($Table_ptr)$Table_ptr:=Table($Table_L)C_TEXT($Table_txt;$Field_txt)$Table_txt:=Table name($Table_L)$Field_txt:="["+$Table_txt+"]"+Field name($Table_L;$Field_L)GET FIELD PROPERTIES($KeyFld_ptr;$FieldType_L)ARRAY INTEGER($RecIDs_ai;0)ARRAY LONGINT($RecIDs_aL;0)ARRAY TEXT($RecIDs_atxt;0)C_TIME($SetFile_t)C_BLOB($BlobToSave)C_BOOLEAN($DoTheMath_b)C_STRING(80;$FileTag_s)$SET_OK_b:=False$FileTag_s:=""MAP FILE TYPES("SETT";".4st";"4D Set Document")Case of : (($FieldType_L#Is Integer )Ê&Ê($FieldType_L#Is LongInt )Ê&Ê($FieldType_L#Is Alpha Field ))ALERT("These Set routines work only with Integer and Alpha fields!"): ($TASK_txt="SAVE")$FileTag_s:="SETUTIL_SAVESET"VARIABLE TO BLOB($FileTag_s;$BlobToSave;*)VARIABLE TO BLOB($Table_L;$BlobToSave;*)VARIABLE TO BLOB($Field_L;$BlobToSave;*)VARIABLE TO BLOB($FieldType_L;$BlobToSave;*)Case of : ($FieldType_L=Is Integer )SELECTION TO ARRAY($KeyFld_ptr->;$RecIDs_ai)VARIABLE TO BLOB($RecIDs_ai;$BlobToSave;*): ($FieldType_L=Is LongInt )SELECTION TO ARRAY($KeyFld_ptr->;$RecIDs_aL)VARIABLE TO BLOB($RecIDs_aL;$BlobToSave;*): ($FieldType_L=Is Alpha Field )SELECTION TO ARRAY($KeyFld_ptr->;$RecIDs_atxt)VARIABLE TO BLOB($RecIDs_atxt;$BlobToSave;*)End case $SetFile_t:=Create document("";"SETT")If (OK=1)C_TEXT($SetFileName_txt)$SetFileName_txt:=DocumentCLOSE DOCUMENT($SetFile_t)C_TEXT($fileExt_txt)$fileExt_txt:=GetFileExtension ($SetFileName_txt)If ($fileExt_txt#".4st")C_TEXT($FilePath_txt)$FilePath_txt:=Substring($SetFileName_txt;1;Length($SetFileName_txt)-Length($fileExt_txt))If (Test path name($FilePath_txt+".4st")=Is a document )ÊÊ`file already exists - we will replace contents anywayElse ÊÊ`does not exist - rename file created to one with correct extersionMOVE DOCUMENT($SetFileName_txt;($FilePath_txt+".4st"))End if $SetFileName_txt:=$FilePath_txt+".4st"End if BLOB TO DOCUMENT($SetFileName_txt;$BlobToSave)$SET_OK_b:=TrueEnd if : (($TASK_txt="LOAD")Ê|Ê($TASK_txt="ADD")Ê|Ê($TASK_txt="SUBTRACT"))$SetFile_t:=Open document("";"SETT")If (OK=1)C_TEXT($SetFileName_txt;$StoreTable_txt;$StoreField_txt)$SetFileName_txt:=DocumentCLOSE DOCUMENT($SetFile_t)DOCUMENT TO BLOB($SetFileName_txt;$BlobToSave)C_LONGINT($offset_L;$StoredTable_L;$StoredField_L;$StoredFieldType_L)$offset_L:=0$DoTheMath_b:=TrueBLOB TO VARIABLE($BlobToSave;$FileTag_s;$offset_L)If ($FileTag_s="SETUTIL_SAVESET")BLOB TO VARIABLE($BlobToSave;$StoredTable_L;$offset_L)BLOB TO VARIABLE($BlobToSave;$StoredField_L;$offset_L)BLOB TO VARIABLE($BlobToSave;$StoredFieldType_L;$offset_L)$StoreTable_txt:=Table name($StoredTable_L)$StoreField_txt:="["+$StoreTable_txt+"]"+Field name($StoredTable_L;$StoredField_L)SET QUERY DESTINATION(Into set ;"SETUTILSETTOLOAD")Case of : ($StoredTable_L#$Table_L)ALERT("Table ["+$StoreTable_txt+"] stored in selected set file does not match required Table  ["+$Table_txt+"] !!!!")$DoTheMath_b:=False: ($StoredField_L#$Field_L)ALERT("Field  "+$StoreField_txt+" stored in selected set file does not match required Field "+$Field_txt+" !!!!")$DoTheMath_b:=False: ($StoredFieldType_L#$FieldType_L)ALERT("Field type "+String($StoredFieldType_L)+" stored in selected set file does not match required Field type "+String($FieldType_L)+" for field "+$Field_txt+" !!!!")$DoTheMath_b:=False: ($FieldType_L=Is Integer )BLOB TO VARIABLE($BlobToSave;$RecIDs_ai;$offset_L)QUERY WITH ARRAY($KeyFld_ptr->;$RecIDs_ai): ($FieldType_L=Is LongInt )BLOB TO VARIABLE($BlobToSave;$RecIDs_aL;$offset_L)QUERY WITH ARRAY($KeyFld_ptr->;$RecIDs_aL): ($FieldType_L=Is Alpha Field )BLOB TO VARIABLE($BlobToSave;$RecIDs_atxt;$offset_L)QUERY WITH ARRAY($KeyFld_ptr->;$RecIDs_atxt)End case SET QUERY DESTINATION(Into current selection )If ($DoTheMath_b)CREATE SET($Table_Ptr->;"SETUTILCURRSET")Case of : ($TASK_txt="LOAD")COPY SET("SETUTILSETTOLOAD";"SETUTILCURRSET"): ($TASK_txt="ADD")UNION("SETUTILCURRSET";"SETUTILSETTOLOAD";"SETUTILCURRSET"): ($TASK_txt="SUBTRACT")DIFFERENCE("SETUTILCURRSET";"SETUTILSETTOLOAD";"SETUTILCURRSET"): ($TASK_txt="INTERSECT")INTERSECTION("SETUTILCURRSET";"SETUTILSETTOLOAD";"SETUTILCURRSET")End case USE SET("SETUTILCURRSET")CLEAR SET("SETUTILCURRSET")CLEAR SET("SETUTILSETTOLOAD")$SET_OK_b:=TrueEnd if Else ALERT("File does not contain a set of records!")$SET_OK_b:=FalseEnd if Else $SET_OK_b:=FalseEnd if End case SET BLOB SIZE($BlobToSave;0)ARRAY INTEGER($RecIDs_ai;0)ARRAY LONGINT($RecIDs_aL;0)ARRAY TEXT($RecIDs_atxt;0)$0:=$SET_OK_b