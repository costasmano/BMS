  `----------------------------------------------------  `User name (OS): Charles Miller  `Date and time: 10/01/13, 16:43:57  `----------------------------------------------------  `Method: ut_UpdateMaximo  `Description  `  ` Parameters  ` ----------------------------------------------------If (False)Mods_2013_09   `r001 `   `Modified by: Charles Miller (10/1/13 16:43:58)End if InitProcessVar InitPers C_BOOLEAN($OkToProceed_b)$OkToProceed_b:=ut_LoadSQLConnectionInfo ("MAXDEV")If (Not($OkToProceed_b))ut_CreateOrUpdateSQLConnectionD ("MAXDEV")End if C_LONGINT($Loop_L;$ElementLoop_L;$StdPhotLoop_L)Compiler_maximo SQL LOGIN("ODBC:"+[SQL_Connections]SQL_OBDCName_s;[SQL_Connections]SQL_UserName_s;[SQL_Connections]SQL_Password_s)C_TEXT($SQLStatmnt_txt)ARRAY LONGINT($MaxOurInspectionIDS_aL;0)SQL EXECUTE("Select inspid from Inspections";$MaxOurInspectionIDS_aL)While (Not(SQL End selection))SQL LOAD RECORD(SQL All Records )End while SQL CANCEL LOADC_LONGINT($INSPID_L;$FindPosition_L)C_TEXT($BIN_txt;$TeamLeader_txt)C_DATE($InspDate_d)C_TEXT($PFlag_txt)QUERY([Inspections])C_STRING(50;$TeamLeader_s;$BIN_s)For ($Loop_L;1;Records in selection([Inspections]))GOTO SELECTED RECORD([Inspections];$Loop_L)QUERY([Bridge MHD NBIS];[Bridge MHD NBIS]BIN=[Inspections]BIN)$BIN_s:="D"+String(Num([Bridge MHD NBIS]Item2))+"-"+[Bridge MHD NBIS]BDEPT+"-"+[Bridge MHD NBIS]BIN$INSPID_L:=[Inspections]InspID$InspDate_d:=[Inspections]Insp DatePERS_GetInfo ([Inspections]TeamLeader;"LASTNAMEFI";->$TeamLeader_txt)$TeamLeader_txt:=Replace string($TeamLeader_txt;"'";"")$TeamLeader_s:=Substring($TeamLeader_txt;1;50)$FindPosition_L:=Find in array($MaxOurInspectionIDS_aL;$INSPID_L)$PFlag_txt:="N"If ($FindPosition_L>0)DELETE FROM ARRAY($MaxOurInspectionIDS_aL;$FindPosition_L;1)Else SQL EXECUTE("insert into inspections (inspectionsid, inspid, BIN, INSPDATE, TEAMLEADER) values ( inspectionsidseq.nextval, :$INSPID_L, :$BIN_s, :$InspDate_d, :$TeamLeader_s) ; ")SQL CANCEL LOADEnd if ARRAY LONGINT($ElementIDS_aL;0)SQL EXECUTE("Select ELMSAFETYID from ELEMENTSSAFETY where INSPID = :$INSPID_L ";$ElementIDS_aL)While (Not(SQL End selection))SQL LOAD RECORD(SQL All Records )End while SQL CANCEL LOADQUERY([ElementsSafety];[ElementsSafety]InspID=$INSPID_L)C_STRING(100;$ESDesc_s)C_STRING(50;$ESDef_s;$ESPrit_s)C_TEXT($ESComm_txt)C_LONGINT($ESID_L;$ElementDictPos_l)For ($ElementLoop_L;1;Records in selection([ElementsSafety]))GOTO SELECTED RECORD([ElementsSafety];$ElementLoop_L)$ESID_L:=[ElementsSafety]ElmSafetyID$ESPrit_s:=[ElementsSafety]Priority$ESDef_s:=[ElementsSafety]Deficiency$FindPosition_L:=Find in array($ElementIDS_aL;$ESID_L)$PFlag_txt:="N"If (Length([ElementsSafety]Description)>0)$ESDesc_s:=[ElementsSafety]DescriptionElse $ElementDictPos_l:=Find in array(◊ELMTDICT_ELNum_ai;[ElementsSafety]ElementNo)$ESDesc_s:=◊ELMTDICT_Txt_as{$ElementDictPos_l}End if $ESComm_txt:=Fn_GetTextBlob ([ElementsSafety]ElmComments)$PFlag_txt:="N"If ($FindPosition_L>0)DELETE FROM ARRAY($ElementIDS_aL;$FindPosition_L;1)Else SQL EXECUTE("insert into ELEMENTSSAFETY (ELEMENTSSAFETYID, DESCRIPTION, INSPID, COMMENTS, DEFICIENCY, PRIORITY, ELMSAFETYID, PROCESSED ) values (ELEMENTSSAFETYIDseq.nextval, :$ESDesc_s, :$INSPID_L, :$ESComm_txt, :$ESDef_s, :$ESPrit_s, :$ESID_L, :$PFlag_txt); ")SQL CANCEL LOADEnd if End for ARRAY LONGINT($StandardPhotoIDS_aL;0)SQL EXECUTE("Select STANDARDPHOTOID from STANDARDPHOTOS where INSPID = :$INSPID_L ";$StandardPhotoIDS_aL)While (Not(SQL End selection))SQL LOAD RECORD(SQL All Records )End while SQL CANCEL LOADQUERY([Standard Photos];[Standard Photos]InspID=$INSPID_L)C_STRING(100;$StdPhotoDesciption_s)C_BLOB($StdPhotoPicture_blb)C_LONGINT($StdPhotoID_L)C_PICTURE($maximoPicture_p)For ($StdPhotLoop_L;1;Records in selection([Standard Photos]))GOTO SELECTED RECORD([Standard Photos];$StdPhotLoop_L)$StdPhotoID_L:=[Standard Photos]StdPhotoIDCase of : ([Standard Photos]PictType=BMS Photo )$StdPhotoDesciption_s:="Photo ": ([Standard Photos]PictType=BMS Sketch )$StdPhotoDesciption_s:="Sketch ": ([Standard Photos]PictType=BMS Chart )$StdPhotoDesciption_s:="Chart "Else $StdPhotoDesciption_s:="Unknown "End case $StdPhotoDesciption_s:=$StdPhotoDesciption_s+String([Standard Photos]SeqNum)$FindPosition_L:=Find in array($StandardPhotoIDS_aL;$StdPhotoID_L)$PFlag_txt:="N"$maximoPicture_p:=[Standard Photos]Std Photo  `CONVERT PICTURE($maximoPicture_p;"JPEG")PICTURE TO BLOB($maximoPicture_p;$StdPhotoPicture_blb;"JPEG")$PFlag_txt:="N"If ($FindPosition_L>0)DELETE FROM ARRAY($StandardPhotoIDS_aL;$FindPosition_L;1)Else SQL EXECUTE("insert into STANDARDPHOTOS (STANDARDPHOTOSID, DESCRIPTION, INSPID, STANDARDPHOTO, STANDARDPHOTOID, PROCESSED ) values (STANDARDPHOTOSIDseq.nextval, :$StdPhotoDesciption_s, :$INSPID_L, :$StdPhotoPicture_blb , :$StdPhotoID_L,"+" :$PFlag_txt); ")SQL CANCEL LOADEnd if End for End for SQL LOGOUT  `End ut_UpdateMaximo