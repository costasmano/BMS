  ` ----------------------------------------------------  ` ut_PRJRetrieveConstructionCont  ` User name (OS): cjmiller  ` Date and time: 04/27/06, 16:16:41  ` ----------------------------------------------------  ` Description  `   `  ` Parameters  ` ----------------------------------------------------If (False)Mods_2006_CJMv2 Mods_2007_CJM_v5310 Mods_2007_CJM_v5310   `06/20/07 `Add data to stored procedure and a new stored procedure callMods_2007_CM12_5301   `10/01/07 `Check for more than one constr project.  ` Modified by: costasmanousakis-(Designer)-(10/10/2007 13:54:41)Mods_2007_CM12_5301   ` Added array PRJ_ComplDate_2_atxt to get more recent completion dates  ` Modified by: costasmanousakis-(Designer)-(10/11/2007 16:33:42)Mods_2007_CM12_5301   `Go thru all [PRJ_ProjectDetails] recs with PF_FileID>0 to update construction contracts.Mods_2007_CJM_v54   `r001 `11/13/07, 11:45:28`Make param code no more than 20 charactersMods_2009_07   `r003 `07/27/09, 10:39:03   `Fix errors when SQL calls failMods_2011_06   ` CJ Miller`06/14/11, 13:25:05      ` Type all local variables for v11Mods_2013_09   `r001 `Only create or update [PRJ_ConstructionProject] if PRJ_ConstructionContract_atxt{$Loop_l} is not blank  `Modified by: Charles Miller (9/4/13 13:16:30)End if C_TEXT($EOL)C_TIME($SQLDocument_tm)If (◊PL_LPlatfrm<3)$EOL:=Char(Carriage return )Else $EOL:=Char(Carriage return )+Char(Line feed )End if C_TIME($StartTime_tm;$RemainingTime_tm)C_LONGINT($win)PRJ_SQLRetrieveStats_txt:=PRJ_SQLRetrieveStats_txt+"Begin Retrieve construction contracts  on "+String(Current date(*);7)+" at "+String(Current time(*))+$EOL$win:=ut_OpenNewWindow (500;200;5;4;"Retrieving Construction Contracts")ARRAY TEXT($Error_axt;1)If (SQL_Do ("sp_RTRVConstData";"Built"))SET QUERY DESTINATION(Into current selection )$StartTime_tm:=Current time(*)C_LONGINT($Loop_l;$SizeOfArray_l;$NewRecords_l;$UpdatedRecords_l)$SizeOfArray_l:=Size of array(PRJ_ConstructionContract_atxt)$NewRecords_l:=0$UpdatedRecords_l:=0C_STRING(3;$FirstInitial_s;$MiddleInitial_s)C_BOOLEAN($BlankConstructionContract_b)ARRAY TEXT($Temp_atxt;0)APPEND TO ARRAY($Temp_atxt;"9003")APPEND TO ARRAY($Temp_atxt;"8970")APPEND TO ARRAY($Temp_atxt;"58950")APPEND TO ARRAY($Temp_atxt;"63624")TRACEFor ($Loop_l;1;$SizeOfArray_l)GOTO XY(5;2)MESSAGE("Updating "+String($Loop_l)+" out of "+String($SizeOfArray_l))GOTO XY(5;5)$RemainingTime_tm:=(($SizeOfArray_l/$Loop_l)-1)*(Current time(*)-$StartTime_tm)MESSAGE("Estimated time remaining is "+Time string($RemainingTime_tm))GOTO XY(5;7)MESSAGE("Elapsed time is "+Time string(Current time(*)-$StartTime_tm))$BlankConstructionContract_b:=FalseQUERY([PRJ_ConstructionProject];[PRJ_ConstructionProject]CP_SQLID_l=PRJ_SQLID_al{$Loop_l})If (Find in array($Temp_atxt;PRJ_ConstructionContract_atxt{$Loop_l})>0)TRACEEnd if If (PRJ_ConstructionContract_atxt{$Loop_l}="")$BlankConstructionContract_b:=TrueElse If (Records in selection([PRJ_ConstructionProject])=0)QUERY([PRJ_ConstructionProject];[PRJ_ConstructionProject]CP_ConstructionContractNo_s=PRJ_ConstructionContract_atxt{$Loop_l})If ([PRJ_ConstructionProject]CP_SQLID_l=0)Else REDUCE SELECTION([PRJ_ConstructionProject];0)End if End if End if QUERY([PRJ_ProjectFile];[PRJ_ProjectFile]PF_FileNumber_l=PRJ_FileNumber_ar{$Loop_l})If (Records in selection([PRJ_ProjectFile])=1)ut_LoadRecord (->[PRJ_ProjectFile])If (Date(PRJ_AdvertisedDate_atxt{$Loop_l})#!00/00/00!)  ` Mods_2007_CM12_5301 10/01/07If (Date(PRJ_AdvertisedDate_atxt{$Loop_l})>[PRJ_ProjectFile]PF_Advertised_d)[PRJ_ProjectFile]PF_Advertised_d:=Date(PRJ_AdvertisedDate_atxt{$Loop_l})End if End if SAVE RECORD([PRJ_ProjectFile])If (Not($BlankConstructionContract_b))  `Only create or update if PRJ_ConstructionContract_atxt{$Loop_l} is not blankIf (Records in selection([PRJ_ConstructionProject])=0)CREATE RECORD([PRJ_ConstructionProject])Inc_Sequence ("CP_ConstructionProj";->[PRJ_ConstructionProject]CP_ConstructionProjectID_l)$NewRecords_l:=$NewRecords_l+1Else ut_LoadRecord (->[PRJ_ConstructionProject])$UpdatedRecords_l:=$UpdatedRecords_l+1End if [PRJ_ConstructionProject]CP_ConstructionContractNo_s:=PRJ_ConstructionContract_atxt{$Loop_l}[PRJ_ConstructionProject]CP_SQLID_l:=PRJ_SQLID_al{$Loop_l}[PRJ_ConstructionProject]CP_NTP_d:=Date(PRJ_NTPDate_atxt{$Loop_l})[PRJ_ConstructionProject]PF_FileID_l:=[PRJ_ProjectFile]PF_FileID_l[PRJ_ConstructionProject]CP_Awarded_d:=Date(PRJ_AwardDate_atxt{$Loop_l})[PRJ_ConstructionProject]CP_BidEstimate_r:=PRJ_OFFiceEst_ar{$Loop_l}[PRJ_ConstructionProject]CP_LowBid_r:=PRJ_BidAmt_ar{$Loop_l}[PRJ_ConstructionProject]CP_BidOpening_d:=Date(PRJ_BidOpenedDate_atxt{$Loop_l})[PRJ_ConstructionProject]CP_Completion_d:=Date(PRJ_ComplDate_atxt{$Loop_l})If (Date(PRJ_ComplDate_2_atxt{$Loop_l})#!00/00/00!)If (Date(PRJ_ComplDate_2_atxt{$Loop_l})>[PRJ_ConstructionProject]CP_Completion_d)[PRJ_ConstructionProject]CP_Completion_d:=Date(PRJ_ComplDate_2_atxt{$Loop_l})End if End if If (SQL_Do ("sp_RTRVEWO";"Built"))If (Size of array(PRJ_EWO_atxt)>0)[PRJ_ConstructionProject]CP_EWO_s:=PRJ_EWO_atxt{1}End if End if If (SQL_Do ("sp_RTRVSpecData";"Built"))If (Size of array(PRJ_SpecsFromPrint_as)>0)[PRJ_ConstructionProject]CP_SpecsFromPrint_d:=Date(PRJ_SpecsFromPrint_as{1})[PRJ_ConstructionProject]CP_SpecsToPrint_d:=Date(PRJ_SpecsToPrint_as{1})[PRJ_ConstructionProject]CP_PlansFromPrint_d:=Date(PRJ_PlansFromPrint_as{1})[PRJ_ConstructionProject]CP_PlansToPrint_d:=Date(PRJ_PlansToPrint_as{1})[PRJ_ConstructionProject]CP_ToCashier_d:=Date(PRJ_ToCashier_as{1})End if End if [PRJ_ConstructionProject]CP_FromSQL_b:=TrueSAVE RECORD([PRJ_ConstructionProject])End if End if UNLOAD RECORD([PRJ_ConstructionProject])UNLOAD RECORD([PRJ_ProjectFile])End if End for PRJ_SQLRetrieveStats_txt:=PRJ_SQLRetrieveStats_txt+String($SizeOfArray_l)+" Construction Contract records retrieved"+$eol+String($NewRecords_l)+" New Construction contract  records created"+$Eol+String($UpdatedRecords_l)+" Construction contract  records  updated"+$EolElse PRJ_SQLRetrieveStats_txt:=PRJ_SQLRetrieveStats_txt+"Call to sp_RTRVConstData Failed"+$EolPRJ_SQLRetrieveStats_txt:=PRJ_SQLRetrieveStats_txt+"Error number "+String(ODBC_ErrorNumber_l)+$eol$SQLDocument_tm:=Append document(RTRV_DocmentPath_txt)SEND PACKET($SQLDocument_tm;PRJ_SQLRetrieveStats_txt)CLOSE DOCUMENT($SQLDocument_tm)PRJ_SQLRetrieveStats_txt:=""End if QUERY([PRJ_ProjectDetails];[PRJ_ProjectDetails]PF_FileID_l>0)  `QUERY SELECTION([PRJ_ProjectDetails];[PRJ_ProjectDetails]CP_ConstructionProjectID_l=0)FIRST RECORD([PRJ_ProjectDetails])$SizeOfArray_l:=Records in selection([PRJ_ProjectDetails])SET WINDOW TITLE("Updating Project Details")For ($Loop_l;1;Records in selection([PRJ_ProjectDetails]))GOTO XY(5;2)MESSAGE("Updating "+String($Loop_l)+" out of "+String($SizeOfArray_l))GOTO XY(5;5)$RemainingTime_tm:=(($SizeOfArray_l/$Loop_l)-1)*(Current time(*)-$StartTime_tm)MESSAGE("Estimated time remaining is "+Time string($RemainingTime_tm))GOTO XY(5;7)MESSAGE("Elapsed time is "+Time string(Current time(*)-$StartTime_tm))QUERY([PRJ_ConstructionProject];[PRJ_ConstructionProject]PF_FileID_l=[PRJ_ProjectDetails]PF_FileID_l)If (Records in selection([PRJ_ConstructionProject])>0)  ` Mods_2007_CM12_5301 10/01/07If (Records in selection([PRJ_ConstructionProject])>1)QUERY SELECTION([PRJ_ConstructionProject];[PRJ_ConstructionProject]CP_ConstructionContractNo_s#"")End if ORDER BY([PRJ_ConstructionProject];[PRJ_ConstructionProject]CP_Awarded_d;<)If ([PRJ_ProjectDetails]CP_ConstructionProjectID_l#[PRJ_ConstructionProject]CP_ConstructionProjectID_l)ut_LoadRecord (->[PRJ_ProjectDetails])[PRJ_ProjectDetails]CP_ConstructionProjectID_l:=[PRJ_ConstructionProject]CP_ConstructionProjectID_lSAVE RECORD([PRJ_ProjectDetails])End if End if NEXT RECORD([PRJ_ProjectDetails])End for UNLOAD RECORD([PRJ_ProjectDetails])CLOSE WINDOWPRJ_SQLRetrieveStats_txt:=PRJ_SQLRetrieveStats_txt+"End Retrieve construction contracts  on "+String(Current date(*);7)+" at "+String(Current time(*))+$EOL  `End ut_PRJRetrieveConstructionCont