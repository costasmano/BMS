  ` ----------------------------------------------------  ` ut_PRJRetrievePRJ_Bridge  ` User name (OS): charlesmiller  ` Date and time: 11/12/08, 15:40:22  ` ----------------------------------------------------  ` Description  `   `  ` Parameters  ` ----------------------------------------------------If (False)Mods_2009_07   `r001 `07/09/09, 10:32:44   `Fix defect where bdept not filled in included bin recordsMods_2009_07   `r003 `07/27/09, 10:38:08   `Fix errors when SQL calls failMods_2010_03   `r004 CJ Miller`03/24/10, 11:17:12      `Add code to assign newest Bin when more than one [Bridge MHD NBIS] record foundMods_2011_06   ` CJ Miller`06/14/11, 13:25:05      ` Type all local variables for v11Mods_2012_03   `r001 `Fix beg where call to PRJ_CreateIncludedBINRecord was passing in concatenated BDEPT  `Modified by: Charles Miller (3/20/12 16:27:05)Mods_2013_09   `r001 `removed file number from project details when project ibnfo removes itEnd if C_BOOLEAN($0)$0:=TrueC_TEXT($EOL)If (◊PL_LPlatfrm<3)$EOL:=Char(Carriage return )Else $EOL:=Char(Carriage return )+Char(Line feed )End if C_TIME($StartTime_tm;$RemainingTime_tm;$SQLDocument_tm)PRJ_SQLRetrieveStats_txt:=PRJ_SQLRetrieveStats_txt+"Begin Retrieve Project Bridge "+String(Current date(*);7)+" at "+String(Current time(*))+$EOL$SQLDocument_tm:=Append document(RTRV_DocmentPath_txt)SEND PACKET($SQLDocument_tm;PRJ_SQLRetrieveStats_txt)CLOSE DOCUMENT($SQLDocument_tm)PRJ_SQLRetrieveStats_txt:=""C_LONGINT($win;$Count_l;$InnerLoop_l)$win:=ut_OpenNewWindow (500;200;5;4;"Retrieving Project Bridges")If (SQL_Do ("sp_RTRVPRJ_Bridge";"Built"))UNLOAD RECORD([PRJ_ProjectDetails])READ WRITE([PRJ_ProjectDetails])C_TIME($StartTime_tm;$RemainingTime_tm)C_TEXT($Body_txt;$To_txt;$From_txt;$Subject_txt)$StartTime_tm:=Current time(*)C_LONGINT($Loop_l;$SizeOfArray_l;$NewRecords_l;$ErrorCount_l;$Deletedrecords_l;$UpdatedRecords_l)$NewRecords_l:=0$UpdatedRecords_l:=0$SizeOfArray_l:=Size of array(PRJ_PROJECT_NO_al)$Body_txt:=""PRJ_SQLRetrieveStats_txt:=PRJ_SQLRetrieveStats_txt+"Retrieved "+String($SizeOfArray_l)+" potential Proj Bridge records"+$EOLC_BOOLEAN($SendEmail_b)$SendEmail_b:=FalseARRAY TEXT($BDeptAndFileNumber_atxt;0)ARRAY TEXT($BDeptAndFileNumber_atxt;$SizeOfArray_l)For ($Loop_l;1;$SizeOfArray_l)GOTO XY(5;2)MESSAGE("Updating "+String($Loop_l)+" out of "+String($SizeOfArray_l))GOTO XY(5;5)$RemainingTime_tm:=(($SizeOfArray_l/$Loop_l)-1)*(Current time(*)-$StartTime_tm)MESSAGE("Estimated time remaining is "+Time string($RemainingTime_tm))GOTO XY(5;7)MESSAGE("Elapsed time is "+Time string(Current time(*)-$StartTime_tm))QUERY([Bridge MHD NBIS];[Bridge MHD NBIS]BDEPT=PRJ_BDEPT_atxt{$Loop_l})If (Records in selection([Bridge MHD NBIS])=0)If (PRJ_BDEPT_atxt{$Loop_l}="various")Else QUERY([Parameters];[Parameters]ParamCode="MAIL_TRANSFCHKLIST")$SendEmail_b:=TrueIf (Length($Body_txt)>25000)$To_txt:="Manousakis Costas (MHD) <costas.manousakis@MHD.state.ma.us>"If (Records in selection([Parameters])=1)$To_txt:=[Parameters]DescriptionEnd if $From_txt:=$To_txt$Subject_txt:="Missing BDEPT's  from sp_RTRVPRJ_Bridge"If (ut_SendEmail ($To_txt;$From_txt;"";"";$Body_txt;$Subject_txt;True))End if $SendEmail_b:=False$Body_txt:=""End if $ErrorCount_l:=$ErrorCount_l+1$Body_txt:=$Body_txt+"Error retrieve  BDEPT returned that does not exist. The BDEPT is "+PRJ_BDEPT_atxt{$Loop_l}+". The Project is "+String(PRJ_PROJECT_NO_al{$Loop_l})+"."+Char(13)End if Else $BDeptAndFileNumber_atxt{$Loop_l}:=PRJ_BDEPT_atxt{$Loop_l}+"-"+String(PRJ_PROJECT_NO_al{$Loop_l})QUERY([PRJ_ProjectFile];[PRJ_ProjectFile]PF_FileNumber_l=PRJ_PROJECT_NO_al{$Loop_l})Case of : (Records in selection([PRJ_ProjectFile])>1)QUERY([Parameters];[Parameters]ParamCode="MAIL_TRANSFCHKLIST")$To_txt:="Manousakis Costas (MHD) <costas.manousakis@MHD.state.ma.us>"If (Records in selection([Parameters])=1)$To_txt:=[Parameters]DescriptionEnd if $From_txt:=$To_txt$Body_txt:="More than one project file record found for file number "+String(PRJ_PROJECT_NO_al{$Loop_l})$Subject_txt:="Duplicate file number from sp_RTRVPRJ_Bridge"$ErrorCount_l:=$ErrorCount_l+1If (ut_SendEmail ($To_txt;$From_txt;"";"";$Body_txt;$Subject_txt;True))End if : (Records in selection([PRJ_ProjectFile])=1)SET QUERY DESTINATION(Into set ;"ProjectDetailSet")QUERY([PRJ_ProjectDetails];[PRJ_ProjectDetails]PF_FileID_l=[PRJ_ProjectFile]PF_FileID_l)C_BOOLEAN($Create_b)$Create_b:=FalseIf (Records in set("ProjectDetailSet")=0)  `create detail record$Create_b:=TrueElse SET QUERY DESTINATION(Into current selection )USE SET("ProjectDetailSet")QUERY SELECTION([PRJ_ProjectDetails];[PRJ_ProjectDetails]PRJ_BridgeNo_s="@"+PRJ_BDEPT_atxt{$Loop_l}+"@")If (Records in selection([PRJ_ProjectDetails])=0)USE SET("ProjectDetailSet")SELECTION TO ARRAY([PRJ_ProjectDetails]PRJ_ProjectID_l;$ProjectIDs_al)QUERY WITH ARRAY([PRJ_ProjectDetailsIncludedBINS]PRJ_ProjectID_l;$ProjectIDs_al)SET QUERY DESTINATION(Into variable ;$Count_l)QUERY SELECTION([PRJ_ProjectDetailsIncludedBINS];[PRJ_ProjectDetailsIncludedBINS]PDB_BDEPT_s=PRJ_BDEPT_atxt{$Loop_l})SET QUERY DESTINATION(Into current selection )If ($Count_l=0)$Create_b:=TrueEnd if   `if no detail record   `query invluded bins if no included bin rcord createEnd if End if SET QUERY DESTINATION(Into current selection )If ($Create_b)If ([Bridge MHD NBIS]Item8 BridgeCat="DUM")Else $NewRecords_l:=$NewRecords_l+1CREATE RECORD([PRJ_ProjectDetails])Inc_Sequence ("PRJ_ProjectID_l";->[PRJ_ProjectDetails]PRJ_ProjectID_l)[PRJ_ProjectDetails]PRJ_Comments_txt:="Record  created during SQL import on via sp_RTRVPRJ_Bridge "+String(Current date(*);7)+Char(Carriage return )[PRJ_ProjectDetails]PF_FileID_l:=[PRJ_ProjectFile]PF_FileID_lPRJ_AdditionalBridges If (Records in selection([Bridge MHD NBIS])=1)[PRJ_ProjectDetails]PRJ_PrimaryBin_s:=[Bridge MHD NBIS]BINPRJ_CreateIncludedBINRecord ([Bridge MHD NBIS]BIN;[Bridge MHD NBIS]BDEPT)Else [PRJ_ProjectDetails]PRJ_Comments_txt:=[PRJ_ProjectDetails]PRJ_Comments_txt+"Multiple included BIN records created, not all of which may be correct. "+Char(Carriage return )ARRAY DATE($Created_ad;0)SELECTION TO ARRAY([Bridge MHD NBIS]BIN;$Bins_as;[Bridge MHD NBIS]DateCreated;$Created_ad)MULTI SORT ARRAY($Created_ad;<;$Bins_as;>)[PRJ_ProjectDetails]PRJ_PrimaryBin_s:=$Bins_as{1}For ($InnerLoop_l;1;Size of array($Bins_as))PRJ_CreateIncludedBINRecord ($Bins_as{$InnerLoop_l};PRJ_BDEPT_atxt{$Loop_l})End for End if [PRJ_ProjectDetails]PRJ_BridgeNo_s:=PRJ_DEBridgeNo_s[PRJ_ProjectDetails]PRJ_CityOrTown_s:=Get_Town_Name (Substring([PRJ_ProjectDetails]PRJ_BridgeNo_s;1;6))SAVE RECORD([PRJ_ProjectDetails])UNLOAD RECORD([PRJ_ProjectDetails])End if End if Else   `skip me and add to reportEnd case End if End for   `OK let's remove file IDs from those items that are no longer assignedSET QUERY DESTINATION(Into current selection )QUERY([PRJ_ProjectDetails];[PRJ_ProjectDetails]PF_FileID_l>0)SET QUERY DESTINATION(Into set ;"$PRJDetailSet")QUERY SELECTION([PRJ_ProjectDetails];[PRJ_ProjectDetails]PRJ_Comments_txt="@Record  created during SQL import on via sp_RTRVPRJ_Bridge@")C_TEXT($BDeptAndFileNumber_txt)C_LONGINT($ArrayPosition_L)USE SET("$PRJDetailSet")CLEAR SET("$PRJDetailSet")C_LONGINT($RemovedCount_L)SET QUERY DESTINATION(Into current selection )For ($Loop_l;1;Records in selection([PRJ_ProjectDetails]))GOTO SELECTED RECORD([PRJ_ProjectDetails];$Loop_l)PRJ_PFFileID_L:=[PRJ_ProjectDetails]PF_FileID_lPRJ_DEProjectFileNo_l:=0Begin SQLselect [PRJ_ProjectFile].[PF_FileNumber_l] FROM [PRJ_ProjectFile] WHERE[PRJ_ProjectFile].[PF_FileID_l] = :PRJ_PFFileID_LINTO :PRJ_DEProjectFileNo_lEnd SQL$BDeptAndFileNumber_txt:=Substring([PRJ_ProjectDetails]PRJ_BridgeNo_s;1;6)+"-"+String(PRJ_DEProjectFileNo_l)$ArrayPosition_L:=Find in array($BDeptAndFileNumber_atxt;$BDeptAndFileNumber_txt)If ($ArrayPosition_L<1)If (ut_LoadRecord (->[PRJ_ProjectDetails];5))[PRJ_ProjectDetails]PRJ_Comments_txt:="Record removed from "+String(PRJ_DEProjectFileNo_l)+" on "+String(Current date;7)+Char(Carriage return )+[PRJ_ProjectDetails]PRJ_Comments_txt[PRJ_ProjectDetails]PF_FileID_l:=0SAVE RECORD([PRJ_ProjectDetails])UNLOAD RECORD([PRJ_ProjectDetails])$RemovedCount_L:=$RemovedCount_L+1End if End if End for If ($SendEmail_b)$To_txt:="Manousakis Costas (MHD) <costas.manousakis@MHD.state.ma.us>"If (Records in selection([Parameters])=1)$To_txt:=[Parameters]DescriptionEnd if $From_txt:=$To_txtIf ($ErrorCount_l>1)$Subject_txt:=String($ErrorCount_l)+" Missing BDEPTs from sp_RTRVPRJ_Bridge"Else $Subject_txt:=String($ErrorCount_l)+" Missing BDEPT from sp_RTRVPRJ_Bridge"End if If (ut_SendEmail ($To_txt;$From_txt;"";"";$Body_txt;$Subject_txt;True))End if End if PRJ_SQLRetrieveStats_txt:=PRJ_SQLRetrieveStats_txt+"created "+String($NewRecords_l)+" Proj Bridge records"+$EOLIf ($ErrorCount_l>0)PRJ_SQLRetrieveStats_txt:=PRJ_SQLRetrieveStats_txt+"created email for "+String($ErrorCount_l)+" errors"+$EOLEnd if PRJ_SQLRetrieveStats_txt:=PRJ_SQLRetrieveStats_txt+"Reset File Number to 0 for "+String($RemovedCount_L)+" count Proj Bridge records"+$EOLElse PRJ_SQLRetrieveStats_txt:=PRJ_SQLRetrieveStats_txt+"Call to sp_RTRVPRJ_Bridge Failed"+$EolPRJ_SQLRetrieveStats_txt:=PRJ_SQLRetrieveStats_txt+"Error number "+String(ODBC_ErrorNumber_l)+$eol$SQLDocument_tm:=Append document(RTRV_DocmentPath_txt)SEND PACKET($SQLDocument_tm;PRJ_SQLRetrieveStats_txt)CLOSE DOCUMENT($SQLDocument_tm)PRJ_SQLRetrieveStats_txt:=""$0:=FalseEnd if CLOSE WINDOWCLEAR SET("ProjectDetailSet")PRJ_SQLRetrieveStats_txt:=PRJ_SQLRetrieveStats_txt+"End Retrieve Project Bridge "+String(Current date(*);7)+" at "+String(Current time(*))+$Eol$SQLDocument_tm:=Append document(RTRV_DocmentPath_txt)SEND PACKET($SQLDocument_tm;PRJ_SQLRetrieveStats_txt)CLOSE DOCUMENT($SQLDocument_tm)PRJ_SQLRetrieveStats_txt:=""  `End ut_PRJRetrievePRJ_Bridge